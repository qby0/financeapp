const express = require('express');
const puppeteer = require('puppeteer');
const cors = require('cors');
const bodyParser = require('body-parser');

const app = express();
app.use(cors());
app.use(bodyParser.json());

app.post('/fetch-purchase-info', async (req, res) => {
    const qrCodeData = req.body.qrCodeData;

    if (!qrCodeData) {
        return res.status(400).send({ error: 'QR code data is required' });
    }

    try {
        const browser = await puppeteer.launch({ headless: true });
        const page = await browser.newPage();
        
        await page.goto('https://opd.financnasprava.sk/#!/check');

        await page.type('#input-receipt-id', qrCodeData);
        await page.click('#search-button');

        await page.waitForSelector('.receipt-detail-body');
        const result = await page.$eval('.receipt-detail-body', el => el.innerText);
        console.log(result);

        await browser.close();

        res.send({ success: true, data: result });
    } catch (error) {
        console.error('Error:', error);
        res.status(500).send({ success: false, message: 'Error fetching purchase info' });
    }
});

const PORT = process.env.PORT || 5000;
app.listen(PORT, () => {
    console.log(`Server is running on port ${PORT}`);
});